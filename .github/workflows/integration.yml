name: Integration Test

on:
  workflow_dispatch:

jobs:
  test:
    name: ${{ matrix.pm }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pm: [npm, pnpm, yarn, bun]
        include:
          - pm: npm
            lockfile: package-lock.json
            install: npm ci
          - pm: pnpm
            lockfile: pnpm-lock.yaml
            install: pnpm install --frozen-lockfile
          - pm: yarn
            lockfile: yarn.lock
            install: yarn install --immutable
          - pm: bun
            lockfile: bun.lock
            install: bun install --frozen-lockfile
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        if: matrix.pm == 'pnpm'

      - uses: oven-sh/setup-bun@v2
        if: matrix.pm == 'bun'

      - uses: actions/setup-node@v4
        if: matrix.pm != 'bun'
        with:
          node-version: 24

      - name: Setup test project
        run: |
          rm -f pnpm-lock.yaml package-lock.json yarn.lock bun.lock bun.lockb
          cp fixtures/package.json .
          cp fixtures/${{ matrix.lockfile }} .

      - uses: maou-shonen/node-cache-action@v1
        id: cache

      - name: Output cache status
        run: |
          echo "package-manager: ${{ steps.cache.outputs.package-manager }}"
          echo "lockfile: ${{ steps.cache.outputs.lockfile }}"
          echo "cache-hit: ${{ steps.cache.outputs.cache-hit }}"
          echo "cache-key: ${{ steps.cache.outputs.cache-key }}"

      - run: ${{ matrix.install }}
      - run: test -f node_modules/ms/package.json
