name: Test

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  test-cache-save:
    name: Save (${{ matrix.pm }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pm: [npm, pnpm, yarn, bun]
        include:
          - pm: npm
            lockfile: package-lock.json
            install: npm ci
          - pm: pnpm
            lockfile: pnpm-lock.yaml
            install: pnpm install --frozen-lockfile
          - pm: yarn
            lockfile: yarn.lock
            install: yarn install --immutable
          - pm: bun
            lockfile: bun.lock
            install: bun install --frozen-lockfile
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        if: matrix.pm == 'pnpm'

      - uses: oven-sh/setup-bun@v2
        if: matrix.pm == 'bun'

      - uses: actions/setup-node@v4
        if: matrix.pm != 'bun'
        with:
          node-version: 24

      - name: Setup test project
        run: |
          cp fixtures/package.json .
          cp fixtures/${{ matrix.lockfile }} .

      - uses: ./
        id: cache

      - name: Verify detection
        run: |
          [ "${{ steps.cache.outputs.package-manager }}" = "${{ matrix.pm }}" ]
          [ "${{ steps.cache.outputs.lockfile }}" = "${{ matrix.lockfile }}" ]
          [ -n "${{ steps.cache.outputs.cache-key }}" ]

      - run: ${{ matrix.install }}
      - run: test -f node_modules/ms/package.json

  test-cache-restore:
    name: Restore (${{ matrix.pm }})
    needs: test-cache-save
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pm: [npm, pnpm, yarn, bun]
        include:
          - pm: npm
            lockfile: package-lock.json
          - pm: pnpm
            lockfile: pnpm-lock.yaml
          - pm: yarn
            lockfile: yarn.lock
          - pm: bun
            lockfile: bun.lock
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        if: matrix.pm == 'pnpm'

      - uses: oven-sh/setup-bun@v2
        if: matrix.pm == 'bun'

      - uses: actions/setup-node@v4
        if: matrix.pm != 'bun'
        with:
          node-version: 24

      - name: Setup test project
        run: |
          cp fixtures/package.json .
          cp fixtures/${{ matrix.lockfile }} .

      - uses: ./
        id: cache

      - name: Verify cache hit
        run: |
          echo "cache-hit=${{ steps.cache.outputs.cache-hit }}"
          [ "${{ steps.cache.outputs.cache-hit }}" = "true" ]

      - name: Verify node_modules restored
        run: test -f node_modules/ms/package.json

  test-priority:
    name: Priority (${{ matrix.expected }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - files: "bun.lockb pnpm-lock.yaml"
            expected: bun
          - files: "pnpm-lock.yaml yarn.lock"
            expected: pnpm
          - files: "yarn.lock package-lock.json"
            expected: yarn
    steps:
      - uses: actions/checkout@v4
      - run: touch ${{ matrix.files }}
      - uses: ./
        id: cache
      - run: '[ "${{ steps.cache.outputs.package-manager }}" = "${{ matrix.expected }}" ]'

  test-no-lockfile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./
        id: cache
      - run: '[ -z "${{ steps.cache.outputs.package-manager }}" ]'
